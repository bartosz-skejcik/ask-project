#include <cassert>
#include <cstddef>
#include <iostream>
#include "utils.h"
#include "conversion.h"

#define FG_RED "\x1b[31m"
#define FG_GREEN "\x1b[32m"
#define FG_RESET "\x1b[39m"

static size_t testCounter = 0;
static size_t failedCounter = 0;

using namespace std;
using namespace conversion;

static bool TestConversion(string input, string expected) {
    assert(isBinaryString(expected));
    assert(expected.length() == 128);

    cout << "Test " << ++testCounter << "\t";

    ConversionResult result = ConvertToIEEE(input);
    if (!result.success) {
        cout << FG_RED << "Błąd konwersji" << FG_RESET << " " << input << endl;
        failedCounter++;
        return false;
    }

    if (result.ieeeBits != expected) {
        cout << FG_RED << "FAILED" << FG_RESET << endl;
        cout << "Dla liczby " << input << " oczekiwano inny wynik" << endl;
        cout << result.ieeeBits << " Otrzymano" << endl;
        cout << expected << " Oczekiwano" << endl << endl;

        failedCounter++;
        return false;
    }

    cout << FG_GREEN << "OK" << FG_RESET << " " << input << endl;
    return true;
}

int main (int argc, char *argv[]) {

    cout << "Początek testowania" << endl << endl;

    TestConversion(
            "420.750",
            "01000000000001111010010011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "-420.750",
            "11000000000001111010010011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "105.3",
            "01000000000001011010010100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011"
    );

    TestConversion( // mantysa jest złożona tylko z części całej liczby
            "9999999999999999999999999999999999999999.99999999999999999999999999999",
            "01000000100000111101011000110010100111110001110000110101110010100100101111111010101110111001111101010110000100000000000000000000"
    );
    TestConversion( // identyczne do poprzedniego
            "9999999999999999999999999999999999999999",
            "01000000100000111101011000110010100111110001110000110101110010100100101111111010101110111001111101010110000100000000000000000000"
    );

    TestConversion( // mantysa jest złożona tylko z części ułamkowej liczby
            "0.0000000000000000000000000000001",
            "00111111100110000000001110011101011001100101100010010110100001111111100111101001000000011101010110011111001010010000111011100010"
    );

    TestConversion( // testowanie poprawnego przesunięcia ułamku
            "0.0078125", // 127 zer i jedna 1 na końcu. 1 będzie niejawna, wykładnik się zmieni
            "00111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "0.5",
            "00111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "0.0",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "-0.0",
            "10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "0.1",
            "00111111111110111001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011010"
    );

    TestConversion(
            "0.3",
            "00111111111111010011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011"
    );

    TestConversion(
            "0.7",
            "00111111111111100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110"
    );

    TestConversion(
            "0.987654321098765432109876543210",
            "00111111111111101111100110101101110100111100000110111110100110111000011010010011111100110100100001001010101001101010011110101011"
    );

    TestConversion(
            "1.093",
            "00111111111111110001011111001110110110010001011010000111001010110000001000001100010010011011101001011110001101010011111101111101"
    );

    TestConversion(
            "1.1",
            "00111111111111110001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011010"
    );

    TestConversion(
            "1.2",
            "00111111111111110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011"
    );

    TestConversion(
            "1.3",
            "00111111111111110100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001101"
    );

    TestConversion(
            "1.4",
            "00111111111111110110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110"
    );

    TestConversion(
            "1.5",
            "00111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "1.6",
            "00111111111111111001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011010"
    );

    TestConversion(
            "1.7",
            "00111111111111111011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011"
    );

    TestConversion(
            "1.8",
            "00111111111111111100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001101"
    );

    TestConversion(
            "1.9",
            "00111111111111111110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110"
    );

    TestConversion(
            "1.0000000000000000000000000000007888609052210118054117285652827862296732064351090230047702789306640625",
            "00111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000"
    );

    TestConversion(
            "1.000000000000000000000000000000000000002938735877055718769921841343055614194546663891930218803771879265748344",
            "00111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "1.75",
            "00111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "7654321.9999999",
            "01000000000101011101001100101110110001111111111111111111111110010100101000000011010110010101000011010100001011011110101000011110"
    );

    TestConversion(
            "-7654321.9999999",
            "11000000000101011101001100101110110001111111111111111111111110010100101000000011010110010101000011010100001011011110101000011110"
    );

    TestConversion(
            "2.5",
            "01000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "20.1",
            "01000000000000110100000110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011001100110011010"
    );

    TestConversion(
            "1.987654321098765432109876543210",
            "00111111111111111111110011010110111010011110000011011111010011011100001101001001111110011010010000100101010100110101001111010110"
    );

    TestConversion(
            "1.9999999999999999999999999999999999", // na tym miejscu NIE zaokrągli
            "00111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
    );

    TestConversion(
            "1.99999999999999999999999999999999999", // na tym miejscu zaokrągli
            "01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "1.999999999999999999999999999999999999", // na tym miejscu zaokrągli
            "01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "21.0000000000000000000000000000000000000000000000000000000000000000000456",
            "01000000000000110101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "21.9999999999999999999999999999999999999999999999999999999999999999999999",
            "01000000000000110110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "9999999999999999.5",
            "01000000001101000001110000110111100100110111111000000111111111111111110000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "2596148429267413814265248164610047", // w systemie binarnym "1" 111 razy
            "01000000011011011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100"
    );

    TestConversion(
            "5192296858534827628530496329220094", // w systemie binarnym "1" 112 razy
            "01000000011011101111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100"
    );

    TestConversion(
            "5192296858534827628530496329220095", // w systemie binarnym "1" 111 razy + "0"
            "01000000011011101111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110"
    );

    TestConversion(
            "10384593717069655257060992658440191", // w systemie binarnym "1" 113 razy
            "01000000011011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
    );

    TestConversion(
            "10384593717069655257060992658440190", // w systemie binarnym "1" 112 razy + "0"
            "01000000011011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110"
    );

    TestConversion(
            "20769187434139310514121985316880383", // w systemie binarnym "1" 114 razy, powinno zaokrąglić
            "01000000011100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    );

    TestConversion(
            "20769187434139310514121985316880382", // w systemie binarnym "1" 113 razy + "0"
            "01000000011100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
    );


    cout << endl << "\t" << testCounter << " testów przeprowadzono" << endl;
    cout << "\t" << FG_GREEN << testCounter - failedCounter << " PASSED" << FG_RESET << "\t" << FG_RED << failedCounter << " FAILED" << FG_RESET << endl;

    if (failedCounter == 0) {
        cout << "\t" << FG_GREEN << "Wszystko gra!" << FG_RESET << endl;
        return 0;
    }
    return 42;
}
